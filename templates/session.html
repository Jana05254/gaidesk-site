<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ù„Ø®Øµ Ø¢Ø®Ø± Ø¬Ù„Ø³Ø© | GAIDESK</title>

<style>
  body {
    background:#eef4ef;
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
    -webkit-font-smoothing:antialiased;
    color:#2b241a;
  }
  .wrap {
    max-width:800px;
    margin:32px auto 64px;
    background:#fff;
    border:1px solid rgba(43,36,26,.08);
    box-shadow:
      0 16px 40px rgba(43,36,26,.08),
      0 3px 8px rgba(43,36,26,.05);
    border-radius:20px;
    padding:24px 24px 32px;
  }
  .title {
    font-size:16px;
    font-weight:600;
    color:#2b241a;
    letter-spacing:-0.03em;
    margin-bottom:4px;
  }
  .subtitle {
    font-size:13px;
    color:rgba(43,36,26,.55);
    margin-bottom:24px;
    line-height:1.5;
  }

  .grid2 {
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,1fr);
    gap:16px;
    margin-bottom:24px;
  }
  .card {
    background:#e9f3e9;
    border-radius:14px;
    border:1px solid rgba(91,127,74,.15);
    box-shadow:0 12px 32px rgba(91,127,74,.08);
    padding:16px;
    min-height:120px;
  }
  .cardTitle{
    font-size:13px;
    font-weight:500;
    color:#2b241a;
    letter-spacing:-0.03em;
    margin-bottom:8px;
  }
  .bigNum{
    font-size:24px;
    font-weight:600;
    color:#2b241a;
    letter-spacing:-0.04em;
    line-height:1.2;
    margin-bottom:4px;
  }
  .dimText{
    font-size:12px;
    color:rgba(43,36,26,.55);
    line-height:1.4;
  }

  .alertsBox{
    background:#fff5ec;
    border-radius:14px;
    border:1px solid rgba(196,163,107,.4);
    padding:16px;
    font-size:13px;
    line-height:1.6;
    margin-bottom:24px;
    color:#2b241a;
  }
  .sectionHead{
    font-size:14px;
    font-weight:600;
    color:#2b241a;
    margin-bottom:8px;
    letter-spacing:-0.03em;
  }
  .statRow{
    display:flex;
    justify-content:space-between;
    font-size:13px;
    border-bottom:1px solid rgba(43,36,26,.07);
    padding:8px 0;
  }
  .statRow:last-child{
    border-bottom:none;
  }

  footer {
    margin-top:32px;
    text-align:center;
    font-size:12px;
    color:rgba(43,36,26,.55);
  }
  footer a{
    color:#6d5a3e;
    text-decoration:none;
    font-weight:500;
  }
  footer a:hover{
    text-decoration:underline;
  }

  @media(max-width:600px){
    .grid2{
      grid-template-columns:1fr;
    }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="title">Ù…Ù„Ø®Øµ Ø¢Ø®Ø± Ø¬Ù„Ø³Ø©</div>
  <div class="subtitle" id="sessionInfo">
    (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ© Ø¨Ø¹Ø¯)
  </div>

  <div class="grid2">
    <div class="card">
      <div class="cardTitle">Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</div>
      <div class="bigNum" id="durationTxt">--</div>
      <div class="dimText" id="timeRangeTxt">--</div>
    </div>

    <div class="card">
      <div class="cardTitle">ØªÙ‚ÙŠÙŠÙ… Ø¹Ø§Ù…</div>
      <div class="bigNum" id="ratingTxt">--</div>
      <div class="dimText" id="adviceTxt">Ù†ØµØ§Ø¦Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
    </div>
  </div>

  <div class="alertsBox">
    <div class="sectionHead">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    <div class="statRow"><div>Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©</div><div id="nearCount">0</div></div>
    <div class="statRow"><div>COâ‚‚ Ù…Ø±ØªÙØ¹</div><div id="co2Count">0</div></div>
    <div class="statRow"><div>ØªØ­Ø°ÙŠØ± Ø¥Ø¬Ù‡Ø§Ø¯ (Ø£ØµÙØ±)</div><div id="warn1Count">0</div></div>
    <div class="statRow"><div>Ø¥Ø¬Ù‡Ø§Ø¯ Ø´Ø¯ÙŠØ¯ (Ø£Ø­Ù…Ø±)</div><div id="warn2Count">0</div></div>
  </div>

  <div style="margin-bottom:24px;">
    <div class="sectionHead">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</div>
    <div class="dimText" style="margin-bottom:12px;">Ø£Ù‚Ù„ / Ù…ØªÙˆØ³Ø· / Ø£Ø¹Ù„Ù‰</div>

    <div class="statRow"><div>Ø§Ù„Ù…Ø³Ø§ÙØ© (cm)</div><div id="distStats">--</div></div>
    <div class="statRow"><div>COâ‚‚</div><div id="co2Stats">--</div></div>
    <div class="statRow"><div>Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</div><div id="tempStats">--</div></div>
    <div class="statRow"><div>Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ F</div><div id="fatigueStats">--</div></div>
    <div class="statRow"><div>Ù†Ø¨Ø¶/ØªÙ†ÙØ³ (bpm)</div><div id="bpmStats">--</div></div>
  </div>

  <footer>
    <div>Â© <span id="yearNow"></span> GAIDESK</div>
    <div>
      Ù„Ù„Ù…Ø²ÙŠØ¯: <a href="https://www.linkedin.com/in/YOUR_LINKEDIN" target="_blank" rel="noopener">LinkedIn</a>
    </div>
  </footer>
</div>

<script>
  const yearNowEl = document.getElementById('yearNow');
  yearNowEl.textContent = new Date().getFullYear().toString();

  // Ø¹Ù†Ø§ØµØ±
  const sessionInfoEl  = document.getElementById('sessionInfo');
  const durationTxtEl  = document.getElementById('durationTxt');
  const timeRangeTxtEl = document.getElementById('timeRangeTxt');
  const ratingTxtEl    = document.getElementById('ratingTxt');
  const adviceTxtEl    = document.getElementById('adviceTxt');

  const nearCountEl    = document.getElementById('nearCount');
  const co2CountEl     = document.getElementById('co2Count');
  const warn1CountEl   = document.getElementById('warn1Count');
  const warn2CountEl   = document.getElementById('warn2Count');

  const distStatsEl    = document.getElementById('distStats');
  const co2StatsEl     = document.getElementById('co2Stats');
  const tempStatsEl    = document.getElementById('tempStats');
  const fatigueStatsEl = document.getElementById('fatigueStats');
  const bpmStatsEl     = document.getElementById('bpmStats');

  function fmtDur(sec){
    if(!sec && sec!==0) return "--";
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    if(h>0) return h+"Ø³ "+m+"Ø¯";
    return m+"Ø¯";
  }

  function fmtTime(ts){
    if(!ts) return "â€”";
    const d = new Date(ts);
    return d.toLocaleString('ar-SA', {
      hour:'2-digit', minute:'2-digit',
      weekday:'short'
    });
  }

  function bestRating(summary){
    // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù‡Ø§Ø² ØªÙ‚Ø±ÙŠØ¨ÙŠØ§Ù‹:
    // Ø¥Ø°Ø§ warn2Count Ø£Ùˆ near+co2 >=3 => "Ø³ÙŠØ¦"
    // Ø¥Ø°Ø§ warn1Count>0 Ø£Ùˆ near+co2>=1 => "Ù…Ù‚Ø¨ÙˆÙ„"
    // ÙˆØ¥Ù„Ø§ "Ù…Ù…ØªØ§Ø²"
    const nearN = summary.alerts?.near || 0;
    const co2N  = summary.alerts?.co2  || 0;
    const warn1 = summary.alerts?.warn1 || 0;
    const warn2 = summary.alerts?.warn2 || 0;

    if (warn2>0 || (nearN+co2N)>=3) {
      return {label:"Ø³ÙŠÙ‘Ø¡", tip:"Ø¬Ù„Ø³Ø© Ù…ØªØ¹Ø¨Ø© Ø¬Ø¯Ø§Ù‹. Ù„Ø§Ø²Ù… ÙØªØ±Ø§Øª Ø±Ø§Ø­Ø© Ø£Ù‚ØµØ± ÙˆØªÙ‡ÙˆÙŠØ© Ø£ÙØ¶Ù„."};
    }
    if (warn1>0 || (nearN+co2N)>=1){
      return {label:"Ù…Ù‚Ø¨ÙˆÙ„", tip:"Ø­Ø§ÙˆÙ„ ØªÙ†ØªØ¨Ù‡ Ù„ÙˆØ¶Ø¹ÙŠØªÙƒ ÙˆØªØ§Ø®Ø° Ø¨Ø±ÙŠÙƒØ§Øª ØµØºÙŠØ±Ø© Ù‚Ø¨Ù„ Ù…Ø§ ØªØªØ¹Ø¨ ÙƒØ«ÙŠØ±."};
    }
    return {label:"Ù…Ù…ØªØ§Ø²", tip:"Ø¬Ù„Ø³Ø© Ù…Ù…ØªØ§Ø²Ø©. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø§Ø¯Ø© ğŸ‘Œ"};
  }

  async function fetchSummary(){
    const res = await fetch('/api/session-summary');
    const data = await res.json();

    if(!data || !data.session_key){
      sessionInfoEl.textContent = "Ù…Ø§ÙÙŠ Ø¬Ù„Ø³Ø© Ù…ÙƒØªÙ…Ù„Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.";
      return;
    }

    // ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
    const startTs = data.start_ts;
    const endTs   = data.end_ts;
    const durSec  = data.duration_sec;
    sessionInfoEl.textContent =
      "Ø§Ù„Ø¬Ù„Ø³Ø©: " + data.session_key + " | Ø§Ù„Ø­Ø§Ù„Ø©: " + (data.status || "ØŸ");

    durationTxtEl.textContent  = fmtDur(durSec);
    timeRangeTxtEl.textContent = fmtTime(startTs) + " â†’ " + fmtTime(endTs);

    // ØªÙ‚ÙŠÙŠÙ… Ø¹Ø§Ù…
    const rate = bestRating(data);
    ratingTxtEl.textContent = rate.label;
    adviceTxtEl.textContent = rate.tip;

    // Alerts
    nearCountEl.textContent  = data.alerts?.near  ?? 0;
    co2CountEl.textContent   = data.alerts?.co2   ?? 0;
    warn1CountEl.textContent = data.alerts?.warn1 ?? 0;
    warn2CountEl.textContent = data.alerts?.warn2 ?? 0;

    // Stats (min/avg/max)
    function mkStats(obj, unit=""){
      if(!obj) return "--";
      const mi = (obj.min!=null)?obj.min.toFixed?obj.min.toFixed(1):obj.min:"-";
      const av = (obj.avg!=null)?obj.avg.toFixed?obj.avg.toFixed(1):obj.avg:"-";
      const ma = (obj.max!=null)?obj.max.toFixed?obj.max.toFixed(1):obj.max:"-";
      return mi+unit+" / "+av+unit+" / "+ma+unit;
    }

    distStatsEl.textContent    = mkStats(data.stats?.dist,"cm");
    co2StatsEl.textContent     = mkStats(data.stats?.co2,"");
    tempStatsEl.textContent    = mkStats(data.stats?.temp,"Â°");
    fatigueStatsEl.textContent = mkStats(data.stats?.F,"");
    bpmStatsEl.textContent     = mkStats(data.stats?.bpm," bpm");
  }

  fetchSummary();
</script>
</body>
</html>
