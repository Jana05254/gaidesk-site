<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة GAIDESK</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

  <style>
    body{ background:#f6f8fb; }
    .card{ border:0; border-radius:1rem; box-shadow:0 6px 20px rgba(13,110,253,.06); }
    .metric-value{ font-size:1.8rem; font-weight:800; }
    .small-muted{ color:#6c757d; font-size:.85rem; }
    .chip{ background:#e9f1ff; color:#0d6efd; padding:.2rem .6rem; border-radius:999px; font-weight:600; }

    /* Gauge بسيط باستخدام conic-gradient */
    #gauge{ --v:0.25; width:170px; height:170px; margin:auto; border-radius:50%;
            background: conic-gradient(#0d6efd calc(var(--v)*360deg), #e9ecef 0);
            position:relative; }
    #gauge > .inner{ position:absolute; inset:12%; background:#fff; border-radius:50%;
                     display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.8rem; }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 text-primary fw-bold">GAIDESK</span>
      <div class="d-flex align-items-center gap-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
          <label class="form-check-label" for="autoRefresh">تحديث تلقائي</label>
        </div>
        <button id="btnRefresh" class="btn btn-primary">تحديث الآن</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">

    <!-- شريط التنبيه -->
    <div id="alertBar" class="alert d-none mb-3" role="alert"></div>

    <!-- صف علوي: Gauge + كروت -->
    <div class="row g-3">
      <div class="col-12 col-md-3">
        <div class="card p-3 text-center">
          <div class="small-muted mb-2">إجهاد الجلسة</div>
          <div id="gauge">
            <div class="inner"><span id="gaugeVal">0%</span></div>
          </div>
          <div class="small-muted mt-2">تنبيه عند <span id="stagePct">70%</span> • استراحة عند <span id="forcePct">100%</span></div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="card p-3">
          <div class="small-muted">آخر حرارة</div>
          <div class="metric-value" id="m-temp">–</div>
          <div class="small-muted">°C</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3">
          <div class="small-muted">آخر CO₂</div>
          <div class="metric-value" id="m-co2">–</div>
          <div class="small-muted">ppm</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3">
          <div class="small-muted">وجود</div>
          <div class="metric-value" id="m-presence">–</div>
          <div class="small-muted">0 = لا يوجد، 1 = موجود</div>
        </div>
      </div>
    </div>

    <!-- الرسم -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">الرسم البياني</h5>
            <span class="chip" id="lastUpdated">—</span>
          </div>
          <canvas id="chart" height="88"></canvas>
        </div>
      </div>
    </div>

    <!-- الجدول -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card p-3">
          <h5 class="mb-3">آخر القراءات</h5>
          <div class="table-responsive" style="max-height:480px;">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>الوقت</th>
                  <th>°C</th>
                  <th>CO₂</th>
                  <th>وجود</th>
                  <th>خطر/إجهاد</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="small-muted">المصدر: <code>/api/data</code></div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // =============================
    // إعدادات عامة + قراءة إعدادات التنبيه
    // =============================
    const q = new URLSearchParams(location.search);
    const DEVICE = q.get('device') || '';     // ?device=GAIDESK-01
    const LIMIT  = 25;

    let SETTINGS = { stage_threshold: 0.7, force_break_at: 1.0 };

    async function loadSettings(){
      try{
        const r = await fetch('/api/settings', {cache:'no-store'});
        const s = await r.json();
        SETTINGS = Object.assign(SETTINGS, s || {});
      }catch(e){ /* تجاهل */ }
      // حدّث النص الظاهر
      document.getElementById('stagePct').textContent = Math.round((SETTINGS.stage_threshold||0.7)*100)+'%';
      document.getElementById('forcePct').textContent = Math.round((SETTINGS.force_break_at||1.0)*100)+'%';
    }

    // =============================
    // عناصر DOM
    // =============================
    const rows = document.getElementById('rows');
    const mTemp = document.getElementById('m-temp');
    const mCo2  = document.getElementById('m-co2');
    const mPresence = document.getElementById('m-presence');
    const lastUpdated = document.getElementById('lastUpdated');
    const alertBar = document.getElementById('alertBar');

    // Gauge
    function setStrain(x){ // 0..1
      const g = document.getElementById('gauge');
      const v = Math.max(0, Math.min(1, Number(x)||0));
      g.style.setProperty('--v', v);
      document.getElementById('gaugeVal').textContent = Math.round(v*100)+'%';
    }

    // فورمات الوقت
    function fmtTs(ts){
      const d = new Date(Number(ts));
      return isNaN(d) ? String(ts) : d.toLocaleString('ar-SA');
    }
    // تحويل رقمي آمن
    function num(v){ const n = Number(v); return isNaN(n) ? null : n; }

    // الرسم
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    function buildChart(data){
      const labels = data.map(i=>fmtTs(i.value?.ts || i.key)).reverse();
      const temps  = data.map(i=>num(i.value?.t ?? i.value?.temp ?? i.value?.T ?? i.value?.temperature)).reverse();
      const co2s   = data.map(i=>num(i.value?.co2)).reverse();

      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          {label:'°C',  data:temps, tension:.3, borderWidth:2, pointRadius:0},
          {label:'CO₂', data:co2s,  tension:.3, borderWidth:2, pointRadius:0},
        ]},
        options:{ responsive:true, interaction:{mode:'index', intersect:false},
          scales:{ x:{ticks:{autoSkip:true, maxTicksLimit:8}}, y:{beginAtZero:false} }
        }
      });
    }

    function renderTable(data){
      rows.innerHTML = '';
      data.forEach((item)=>{
        const v = item.value || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtTs(v.ts || item.key)}</td>
          <td>${v.t ?? v.temp ?? v.T ?? v.temperature ?? '—'}</td>
          <td>${v.co2 ?? '—'}</td>
          <td>${v.presence ?? v.p ?? '—'}</td>
          <td>${(v.strain ?? v.risk ?? v.r ?? 0)}</td>
        `;
        rows.appendChild(tr);
      });
    }

    function applyAlerts(last){
      // إخفِ الشريط أولاً
      alertBar.className = 'alert d-none mb-3';
      alertBar.textContent = '';

      const strain = Number(last.strain ?? 0);
      const co2    = Number(last.co2 ?? 0);

      if (strain >= (SETTINGS.force_break_at ?? 1.0)) {
        alertBar.textContent = 'وصلت حد الإجبار: خذ استراحة الآن 🛑';
        alertBar.classList.remove('d-none'); alertBar.classList.add('alert-danger');
      } else if (strain >= (SETTINGS.stage_threshold ?? 0.7)) {
        alertBar.textContent = 'بدأ الإجهاد يعلو: خذ دقيقة تنفّس وتمدد ⏱️';
        alertBar.classList.remove('d-none'); alertBar.classList.add('alert-warning');
      } else if (co2 > 900) {
        alertBar.textContent = 'CO₂ مرتفع: افتح التهوية 🌬️';
        alertBar.classList.remove('d-none'); alertBar.classList.add('alert-info');
      }
    }

    async function loadData(){
      try{
        document.getElementById('btnRefresh').disabled = true;
        const url = `/api/data?limit=${LIMIT}${DEVICE ? `&device=${encodeURIComponent(DEVICE)}` : ''}`;
        const r = await fetch(url, {cache:'no-store'});
        const data = await r.json(); // [{key, value}, ...] تنازلي
        renderTable(data);
        buildChart(data);

        // آخر قراءة
        const last = (data[0] && data[0].value) ? data[0].value : {};
        setStrain(Number(last.strain ?? last.risk ?? 0));
        mTemp.textContent = last.t ?? last.temp ?? last.T ?? last.temperature ?? '—';
        mCo2.textContent  = last.co2 ?? '—';
        mPresence.textContent = last.presence ?? last.p ?? '—';

        applyAlerts(last);

        lastUpdated.textContent = `آخر تحديث: ${new Date().toLocaleTimeString('ar-SA')}`;
      }catch(e){
        console.error(e);
        lastUpdated.textContent = 'خطأ في الجلب';
      }finally{
        document.getElementById('btnRefresh').disabled = false;
      }
    }

    // تشغيل
    let timer=null;
    function startAuto(){ stopAuto(); timer=setInterval(loadData, 5000); }
    function stopAuto(){ if(timer) clearInterval(timer); timer=null; }

    document.getElementById('btnRefresh').addEventListener('click', loadData);
    document.getElementById('autoRefresh').addEventListener('change', e=> e.target.checked ? startAuto() : stopAuto());

    (async function init(){
      await loadSettings();   // اقرأ إعدادات التنبيه أولاً
      await loadData();       // ثم حمّل البيانات
      startAuto();            // وابدأ التحديث الدوري
    })();
  </script>
</body>
</html>
