<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© GAIDESK</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

  <style>
    body{ background:#f6f8fb; }
    .card{ border:0; border-radius:1rem; box-shadow:0 6px 20px rgba(13,110,253,.06); }
    .metric-value{ font-size:1.8rem; font-weight:800; }
    .small-muted{ color:#6c757d; font-size:.85rem; }
    .chip{ background:#e9f1ff; color:#0d6efd; padding:.2rem .6rem; border-radius:999px; font-weight:600; }

    /* Gauge Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… conic-gradient */
    #gauge{ --v:0.25; width:170px; height:170px; margin:auto; border-radius:50%;
            background: conic-gradient(#0d6efd calc(var(--v)*360deg), #e9ecef 0);
            position:relative; }
    #gauge > .inner{ position:absolute; inset:12%; background:#fff; border-radius:50%;
                     display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.8rem; }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 text-primary fw-bold">GAIDESK</span>
      <div class="d-flex align-items-center gap-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
          <label class="form-check-label" for="autoRefresh">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
        </div>
        <button id="btnRefresh" class="btn btn-primary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
    <div id="alertBar" class="alert d-none mb-3" role="alert"></div>

    <!-- ØµÙ Ø¹Ù„ÙˆÙŠ: Gauge + ÙƒØ±ÙˆØª -->
    <div class="row g-3">
      <div class="col-12 col-md-3">
        <div class="card p-3 text-center">
          <div class="small-muted mb-2">Ø¥Ø¬Ù‡Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
          <div id="gauge">
            <div class="inner"><span id="gaugeVal">0%</span></div>
          </div>
          <div class="small-muted mt-2">ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ <span id="stagePct">70%</span> â€¢ Ø§Ø³ØªØ±Ø§Ø­Ø© Ø¹Ù†Ø¯ <span id="forcePct">100%</span></div>
        </div>
      </div>

      <div class="col-12 col-md-3">
        <div class="card p-3">
          <div class="small-muted">Ø¢Ø®Ø± Ø­Ø±Ø§Ø±Ø©</div>
          <div class="metric-value" id="m-temp">â€“</div>
          <div class="small-muted">Â°C</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3">
          <div class="small-muted">Ø¢Ø®Ø± COâ‚‚</div>
          <div class="metric-value" id="m-co2">â€“</div>
          <div class="small-muted">ppm</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card p-3">
          <div class="small-muted">ÙˆØ¬ÙˆØ¯</div>
          <div class="metric-value" id="m-presence">â€“</div>
          <div class="small-muted">0 = Ù„Ø§ ÙŠÙˆØ¬Ø¯ØŒ 1 = Ù…ÙˆØ¬ÙˆØ¯</div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³Ù… -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</h5>
            <span class="chip" id="lastUpdated">â€”</span>
          </div>
          <canvas id="chart" height="88"></canvas>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card p-3">
          <h5 class="mb-3">Ø¢Ø®Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</h5>
          <div class="table-responsive" style="max-height:480px;">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Ø§Ù„ÙˆÙ‚Øª</th>
                  <th>Â°C</th>
                  <th>COâ‚‚</th>
                  <th>ÙˆØ¬ÙˆØ¯</th>
                  <th>Ø®Ø·Ø±/Ø¥Ø¬Ù‡Ø§Ø¯</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="small-muted">Ø§Ù„Ù…ØµØ¯Ø±: <code>/api/data</code></div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // =============================
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© + Ù‚Ø±Ø§Ø¡Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    // =============================
    const q = new URLSearchParams(location.search);
    const DEVICE = q.get('device') || '';     // ?device=GAIDESK-01
    const LIMIT  = 25;

    let SETTINGS = { stage_threshold: 0.7, force_break_at: 1.0 };

    async function loadSettings(){
      try{
        const r = await fetch('/api/settings', {cache:'no-store'});
        const s = await r.json();
        SETTINGS = Object.assign(SETTINGS, s || {});
      }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù†Øµ Ø§Ù„Ø¸Ø§Ù‡Ø±
      document.getElementById('stagePct').textContent = Math.round((SETTINGS.stage_threshold||0.7)*100)+'%';
      document.getElementById('forcePct').textContent = Math.round((SETTINGS.force_break_at||1.0)*100)+'%';
    }

    // =============================
    // Ø¹Ù†Ø§ØµØ± DOM
    // =============================
    const rows = document.getElementById('rows');
    const mTemp = document.getElementById('m-temp');
    const mCo2  = document.getElementById('m-co2');
    const mPresence = document.getElementById('m-presence');
    const lastUpdated = document.getElementById('lastUpdated');
    const alertBar = document.getElementById('alertBar');

    // Gauge
    function setStrain(x){ // 0..1
      const g = document.getElementById('gauge');
      const v = Math.max(0, Math.min(1, Number(x)||0));
      g.style.setProperty('--v', v);
      document.getElementById('gaugeVal').textContent = Math.round(v*100)+'%';
    }

    // ÙÙˆØ±Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Øª
    function fmtTs(ts){
      const d = new Date(Number(ts));
      return isNaN(d) ? String(ts) : d.toLocaleString('ar-SA');
    }
    // ØªØ­ÙˆÙŠÙ„ Ø±Ù‚Ù…ÙŠ Ø¢Ù…Ù†
    function num(v){ const n = Number(v); return isNaN(n) ? null : n; }

    // Ø§Ù„Ø±Ø³Ù…
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    function buildChart(data){
      const labels = data.map(i=>fmtTs(i.value?.ts || i.key)).reverse();
      const temps  = data.map(i=>num(i.value?.t ?? i.value?.temp ?? i.value?.T ?? i.value?.temperature)).reverse();
      const co2s   = data.map(i=>num(i.value?.co2)).reverse();

      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          {label:'Â°C',  data:temps, tension:.3, borderWidth:2, pointRadius:0},
          {label:'COâ‚‚', data:co2s,  tension:.3, borderWidth:2, pointRadius:0},
        ]},
        options:{ responsive:true, interaction:{mode:'index', intersect:false},
          scales:{ x:{ticks:{autoSkip:true, maxTicksLimit:8}}, y:{beginAtZero:false} }
        }
      });
    }

    function renderTable(data){
      rows.innerHTML = '';
      data.forEach((item)=>{
        const v = item.value || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtTs(v.ts || item.key)}</td>
          <td>${v.t ?? v.temp ?? v.T ?? v.temperature ?? 'â€”'}</td>
          <td>${v.co2 ?? 'â€”'}</td>
          <td>${v.presence ?? v.p ?? 'â€”'}</td>
          <td>${(v.strain ?? v.risk ?? v.r ?? 0)}</td>
        `;
        rows.appendChild(tr);
      });
    }

    function applyAlerts(last){
      // Ø¥Ø®ÙÙ Ø§Ù„Ø´Ø±ÙŠØ· Ø£ÙˆÙ„Ø§Ù‹
      alertBar.className = 'alert d-none mb-3';
      alertBar.textContent = '';

      const strain = Number(last.strain ?? 0);
      const co2    = Number(last.co2 ?? 0);

      if (strain >= (SETTINGS.force_break_at ?? 1.0)) {
        alertBar.textContent = 'ÙˆØµÙ„Øª Ø­Ø¯ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±: Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ø¢Ù† ðŸ›‘';
        alertBar.classList.remove('d-none'); alertBar.classList.add('alert-danger');
      } else if (strain >= (SETTINGS.stage_threshold ?? 0.7)) {
        alertBar.textContent = 'Ø¨Ø¯Ø£ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ ÙŠØ¹Ù„Ùˆ: Ø®Ø° Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ†ÙÙ‘Ø³ ÙˆØªÙ…Ø¯Ø¯ â±ï¸';
        alertBar.classList.remove('d-none'); alertBar.classList.add('alert-warning');
      } else if (co2 > 900) {
        alertBar.textContent = 'COâ‚‚ Ù…Ø±ØªÙØ¹: Ø§ÙØªØ­ Ø§Ù„ØªÙ‡ÙˆÙŠØ© ðŸŒ¬ï¸';
        alertBar.classList.remove('d-none'); alertBar.classList.add('alert-info');
      }
    }

    async function loadData(){
      try{
        document.getElementById('btnRefresh').disabled = true;
        const url = `/api/data?limit=${LIMIT}${DEVICE ? `&device=${encodeURIComponent(DEVICE)}` : ''}`;
        const r = await fetch(url, {cache:'no-store'});
        const data = await r.json(); // [{key, value}, ...] ØªÙ†Ø§Ø²Ù„ÙŠ
        renderTable(data);
        buildChart(data);

        // Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©
        const last = (data[0] && data[0].value) ? data[0].value : {};
        setStrain(Number(last.strain ?? last.risk ?? 0));
        mTemp.textContent = last.t ?? last.temp ?? last.T ?? last.temperature ?? 'â€”';
        mCo2.textContent  = last.co2 ?? 'â€”';
        mPresence.textContent = last.presence ?? last.p ?? 'â€”';

        applyAlerts(last);

        lastUpdated.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-SA')}`;
      }catch(e){
        console.error(e);
        lastUpdated.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨';
      }finally{
        document.getElementById('btnRefresh').disabled = false;
      }
    }

    // ØªØ´ØºÙŠÙ„
    let timer=null;
    function startAuto(){ stopAuto(); timer=setInterval(loadData, 5000); }
    function stopAuto(){ if(timer) clearInterval(timer); timer=null; }

    document.getElementById('btnRefresh').addEventListener('click', loadData);
    document.getElementById('autoRefresh').addEventListener('change', e=> e.target.checked ? startAuto() : stopAuto());

    (async function init(){
      await loadSettings();   // Ø§Ù‚Ø±Ø£ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø£ÙˆÙ„Ø§Ù‹
      await loadData();       // Ø«Ù… Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      startAuto();            // ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
    })();
  </script>
</body>
</html>
