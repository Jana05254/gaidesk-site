{% extends "base.html" %}
{% block content %}

<style>
/* دخول ناعم للعنوان */
#dashIntro {
  opacity:0;
  transform: translateY(16px);
  transition: all .4s;
}

/* تنبيه الحالة */
.alertBlock {
  background: rgba(203,183,156,0.08);
  border: 1px solid rgba(203,183,156,0.4);
  border-radius: var(--radius-md);
  box-shadow: 0 20px 40px rgba(203,183,156,0.25);
  padding: 1rem 1.25rem;
  font-size: .8rem;
  line-height: 1.6;
  font-weight: 500;
  color: var(--accent-dark);
  display: none;
  margin-bottom: 1.5rem;
}

/* البطاقة الرئيسية (القيم الحالية) */
.live-preview-card {
  background: #fff;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(0,0,0,0.05);
  box-shadow: var(--shadow-card);
  display: flex;
  flex-direction: column;
  min-height: 100%;
  padding: 1rem 1rem 1.25rem;
  margin-bottom: 2rem;
}

.live-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: .75rem;
  flex-wrap: wrap;
  gap: .5rem;
}
.live-title {
  font-size: .8rem;
  font-weight: 600;
  color: var(--accent-dark);
}
.live-device {
  font-size: .7rem;
  color: var(--text-dim);
  background: var(--accent-bg);
  padding: .25rem .5rem;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.05);
}

/* القيم */
.live-grid {
  display: grid;
  grid-template-columns: repeat(2,minmax(0,1fr));
  gap: .75rem;
}
.live-item {
  background: var(--bg-page);
  border-radius: var(--radius-md);
  border: 1px solid rgba(0,0,0,0.05);
  padding: .75rem .9rem;
  box-shadow: 0 10px 25px rgba(0,0,0,0.03) inset;
  display: flex;
  flex-direction: column;
  gap: .4rem;
}
.live-label {
  font-size: .75rem;
  font-weight: 500;
  color: var(--text-dim);
}
.live-value {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-main);
}
.live-sub {
  font-size: .7rem;
  color: var(--text-dim);
  line-height: 1.4;
}
.live-fatigue-wrapper {
  display: flex;
  align-items: center;
  gap: .5rem;
}
.fatigue-circle {
  width: 48px;
  height: 48px;
  border-radius: 999px;
  background: radial-gradient(circle at 30% 30%, #fff 0%, #fff 40%, rgba(203,183,156,0.4) 100%);
  border: 2px solid var(--accent-mid);
  box-shadow: 0 10px 20px rgba(203,183,156,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
}
.fatigue-num {
  font-size: .9rem;
  font-weight: 600;
  color: var(--accent-dark);
}

/* أسفل البطاقة */
.live-footer {
  margin-top: 1rem;
  font-size: .72rem;
  color: var(--text-dim);
  display: flex;
  flex-direction: column;
  gap: .5rem;
}
.tip {
  line-height: 1.5;
}
.see-full {
  font-size: .75rem;
  color: var(--accent-dark);
  text-decoration: none;
  font-weight: 500;
  display: inline-block;
}
.see-full:hover { text-decoration: underline; }

/* جدول آخر القراءات */
.table-card {
  background: #fff;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(0,0,0,0.05);
  box-shadow: var(--shadow-card);
  padding: 1rem 1rem 1.25rem;
  overflow-x: auto;
}

.readings-header {
  font-size: .9rem;
  font-weight: 600;
  color: var(--accent-dark);
  margin-bottom: .75rem;
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:.5rem;
}
.readings-header small {
  font-size: .7rem;
  color: var(--text-dim);
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: .75rem;
  color: var(--text-main);
}
.data-table th {
  text-align: right;
  font-weight: 500;
  color: var(--text-dim);
  padding: .5rem .5rem;
  border-bottom: 1px solid rgba(0,0,0,0.08);
  white-space: nowrap;
}
.data-table td {
  padding: .6rem .5rem;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  vertical-align: top;
  white-space: nowrap;
}
</style>

<div class="section-wrapper" style="max-width:1280px; margin-top:2rem;">

  <!-- عنوان وتعريف سريع -->
  <div id="dashIntro">
    <h2 class="section-title" style="text-align:center; margin-bottom:1rem;">
      المراقبة الآن
    </h2>
    <p class="section-desc" style="text-align:center; max-width:48ch; margin:0 auto 2rem;">
      هذه قراءات جسمك وبيئتك خلال جلستك الحالية، محدثة من GAIDESK.
    </p>
  </div>

  <!-- بلوك تنبيه (يظهر فقط لو في مشكلة حقيقية) -->
  <div id="alertBlock" class="alertBlock"></div>

  <!-- البطاقة الرئيسية (آخر قيم) -->
  <div class="live-preview-card">
    <div class="live-header">
      <div class="live-title">آخر قراءة مسجلة</div>
      <div class="live-device" id="devName">GAIDESK-01</div>
    </div>

    <div class="live-grid">
      <div class="live-item">
        <div class="live-label">الحرارة</div>
        <div class="live-value"><span id="tempVal">--</span>°C</div>
        <div class="live-sub">جو الغرفة الآن.</div>
      </div>

      <div class="live-item">
        <div class="live-label">CO₂</div>
        <div class="live-value"><span id="co2Val">--</span> ppm</div>
        <div class="live-sub">لو ارتفع كثير يطيح التركيز.</div>
      </div>

      <div class="live-item">
        <div class="live-label">وجودك على المكتب</div>
        <div class="live-value" id="presenceVal">--</div>
        <div class="live-sub">1 = موجود، 0 = مو جالس / قمت.</div>
      </div>

      <div class="live-item">
        <div class="live-label">إجهاد الجلسة (Fatigue)</div>
        <div class="live-fatigue-wrapper">
          <div class="fatigue-circle">
            <span class="fatigue-num" id="fatigueNum">0%</span>
          </div>
          <div style="font-size:.75rem; line-height:1.5; color:var(--text-dim);">
            <div>يوصل 100% = لازم بريك</div>
            <div id="fatigueText" style="color:var(--accent-dark); font-weight:600;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="live-footer">
      <div class="tip" id="tipLine">...</div>
      <a class="see-full" href="{{ url_for('session_page') }}">شوف ملخص الجلسة</a>
    </div>
  </div>

  <!-- جدول آخر القراءات -->
  <div class="table-card">
    <div class="readings-header">
      <div>آخر القراءات</div>
      <small id="lastUpdateTxt">آخر تحديث: --</small>
    </div>

    <table class="data-table" id="dataTable">
      <thead>
        <tr>
          <th>الوقت</th>
          <th>الجهاز</th>
          <th>إجهاد %</th>
          <th>وجود</th>
          <th>CO₂</th>
          <th>°C</th>
          <th>المسافة</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- نعبيها بالـ JS -->
      </tbody>
    </table>
  </div>

  <div style="text-align:center; margin-top:2rem;">
    <a class="btn-ghost" href="{{ url_for('landing') }}">العودة للرئيسية</a>
  </div>
</div>

<script>
window.addEventListener('load', () => {
  const block = document.getElementById('dashIntro');
  block.style.opacity = "1";
  block.style.transform = "translateY(0)";
});

function tsToLocalString(ts){
  if(!ts) return "--";
  // ts يفترض ملي ثانية (من Firebase)
  try {
    const d = new Date(ts);
    return d.toLocaleString('ar-SA', { hour12:false });
  } catch {
    return "--";
  }
}

function presenceText(p){
  if(p === 1 || p === "1") return "موجود";
  if(p === 0 || p === "0") return "مو موجود";
  return "—";
}

function buildRow(item, device){
  return `
    <tr>
      <td>${tsToLocalString(item.ts)}</td>
      <td>${device}</td>
      <td>${item.F ?? "—"}%</td>
      <td>${presenceText(item.presence)}</td>
      <td>${item.co2 ?? "—"}</td>
      <td>${item.t ?? "—"}</td>
      <td>${(item.dist!=null && item.dist!=="") ? item.dist+" cm" : "—"}</td>
    </tr>
  `;
}

async function fetchData(){
  try {
    const r = await fetch('/api/data?limit=20&device=GAIDESK-01');
    const arr = await r.json();
    if(!Array.isArray(arr) || !arr.length){
      document.getElementById('tipLine').textContent =
        "لا توجد قراءات حديثة. هل الجهاز شغال وموصول بالFirebase؟";
      return;
    }

    // آخر قراءة (أجدد عنصر)
    const latest = arr[0];

    // عبّي البلوك العلوي
    document.getElementById('tempVal').textContent     = latest.t ?? "--";
    document.getElementById('co2Val').textContent      = latest.co2 ?? "--";
    document.getElementById('presenceVal').textContent = presenceText(latest.presence);
    const f = latest.F ?? 0;
    document.getElementById('fatigueNum').textContent  = f + "%";

    let fatigueMsg = "";
    if(f >= 100){
      fatigueMsg = "قف فوراً وخذ بريك";
    } else if(f >= 70){
      fatigueMsg = "قربت تتعب، وقف شوي";
    } else {
      fatigueMsg = "وضعك عادي الآن";
    }
    document.getElementById('fatigueText').textContent = fatigueMsg;

    // نص التلميح
    document.getElementById('tipLine').textContent = (
      f >= 100
        ? "جلسة إنتهت فعلياً. جسمك مستنزف. قم وخذ هواء جديد."
        : (f >= 70
            ? "إجهاد واضح. بريك خفيف بيحميك قبل ما توصل 100%."
            : "ماشي كويس. حافظ على المسافة عن الشاشة وجودة التنفس.")
    );

    // آخر تحديث
    document.getElementById('lastUpdateTxt').textContent =
      "آخر تحديث: " + tsToLocalString(latest.ts);

    // جدول آخر القراءات
    const body = document.getElementById('tableBody');
    body.innerHTML = "";
    arr.forEach(item => {
      body.insertAdjacentHTML("beforeend", buildRow(item, "GAIDESK-01"));
    });

    // تنبيه بصري لو الوضع سيء (CO2 عالي جداً أو Fatigue 100%)
    const alertDiv = document.getElementById('alertBlock');
    let alertMsg = "";
    if(f >= 100){
      alertMsg = "تحذير إجهاد عالي جداً: جسمك خلص فعلياً. خذ استراحة كاملة.";
    } else if(latest.co2 && Number(latest.co2) > 2000){
      alertMsg = "تنبيه جودة هواء: CO₂ مرتفع جداً. افتح نافذة أو تحرك من المكان.";
    }
    if(alertMsg){
      alertDiv.textContent = alertMsg;
      alertDiv.style.display = "block";
    } else {
      alertDiv.style.display = "none";
    }

  } catch(e){
    // في حال فشل الاتصال بالكامل مع السيرفر
    document.getElementById('tipLine').textContent =
      "ما قدرنا نجيب بيانات. شيك الاتصال.";
  }
}

fetchData();
// ممكن تحدثي كل X ثانية لو تبين live:
setInterval(fetchData, 10000);
</script>

{% endblock %}
