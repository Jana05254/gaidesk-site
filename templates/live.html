<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ูุฑุงูุจุฉ ุงูุขู | GAIDESK</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ุฃููุงู ุงููููุฉ -->
  <style>
    :root {
      --bg-main: #f5faf4;        /* ุฃุฎุถุฑ ุดูุงู ูุงุชุญ ุฌุฏุง */
      --panel:   #eef5ee;        /* ุจุงููู ุฎููู */
      --text-main:#1f2922;       /* ูุต ุบุงูู ูุงุฆู ุฃุฎุถุฑ */
      --accent:  #8f6a3b;        /* ุงูุฐูุจู ุงูุจูู ุญู ุงูุดุนุงุฑ */
      --danger:  #b94a4a;
      --ok:      #1f7a4a;
    }
    body {
      background-color: var(--bg-main);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", "Noto Sans Arabic", sans-serif;
    }
    .glass-card {
      background-color: var(--panel);
      backdrop-filter: blur(8px);
      box-shadow:
        0 20px 40px rgba(0,0,0,.07),
        0 1px 1px rgba(0,0,0,.04);
      border-radius: 1rem;
      border: 1px solid rgba(0,0,0,.04);
    }
    .section-title {
      font-size: .8rem;
      color: rgba(31,41,34,.55);
      font-weight: 500;
      letter-spacing: -.02em;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .badge-soft {
      background-color: rgba(31,122,74,.08);
      color: var(--ok);
      font-size: .7rem;
      padding: .25rem .5rem;
      border-radius: .4rem;
      line-height: 1rem;
      font-weight: 500;
    }
    .badge-warn {
      background-color: rgba(185,74,74,.08);
      color: var(--danger);
      font-size: .7rem;
      padding: .25rem .5rem;
      border-radius: .4rem;
      line-height: 1rem;
      font-weight: 500;
    }
  </style>

  <!-- ุฎุทูุท ุฃุฑูุงู ูุชุณุงููุฉ ุงูุนุฑุถ ูููุฑุงุกุงุช -->
  <style>
    .mono {
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- ุงูููุฏุฑ / ุงููุงู -->
  <header class="w-full border-b border-black/5 bg-[var(--panel)]/70 backdrop-blur sticky top-0 z-40">
    <div class="max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-4 px-4 py-3">

      <!-- ููุฌู ุจุณูุท -->
      <a href="/" class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-full bg-[var(--accent)]/90 text-white flex items-center justify-center font-semibold text-xs tracking-tight shadow-sm">
          G
        </div>
        <div class="flex flex-col leading-tight">
          <span class="text-sm font-semibold text-[var(--text-main)] -mb-0.5">GAIDESK</span>
          <span class="text-[10px] text-[var(--text-main)]/60">Smart Desk Coach</span>
        </div>
      </a>

      <!-- ุฑูุงุจุท -->
      <nav class="flex flex-wrap gap-2 text-[13px] font-medium">
        <a class="px-3 py-1.5 rounded-lg hover:bg-white hover:text-[var(--text-main)]/90 transition"
           href="/">ุงูุฑุฆูุณูุฉ</a>

        <a class="px-3 py-1.5 rounded-lg bg-white text-[var(--text-main)] shadow-sm"
           href="/dashboard">ุงููุฑุงูุจุฉ ุงูุขู</a>

        <a class="px-3 py-1.5 rounded-lg hover:bg-white hover:text-[var(--text-main)]/90 transition"
           href="/summary">ููุฎุต ุงูุฌูุณุฉ</a>

        <a class="px-3 py-1.5 rounded-lg hover:bg-white hover:text-[var(--text-main)]/90 transition"
           href="/about">ุนู ุงููุดุฑูุน</a>
      </nav>

    </div>
  </header>

  <!-- ุงููุญุชูู -->
  <main class="flex-1 w-full max-w-6xl mx-auto px-4 py-8 space-y-10">

    <!-- ===== ุตู ุงูุจุทุงูุงุช ุงูุฑุฆูุณูุฉ ===== -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- ุจุทุงูุฉ ุงูุญุงูุฉ ุงูุญุงููุฉ -->
      <div class="glass-card p-5 flex flex-col justify-between">
        <div class="flex items-start justify-between">
          <div class="section-title">
            <span class="inline-block h-2 w-2 rounded-full bg-[var(--ok)] shadow-[0_0_8px_rgba(31,122,74,.6)]"></span>
            <span>ุงูุฌูุณุฉ ุงูุขู</span>
          </div>
          <div id="deviceName"
               class="text-[11px] text-[var(--text-main)]/60 font-medium bg-white/60 px-2 py-[2px] rounded-md border border-black/5">
            GAIDESK-01
          </div>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-4 text-center">
          <!-- ุญุฑุงุฑุฉ -->
          <div class="bg-white/70 rounded-lg border border-black/5 py-4">
            <div class="text-[11px] text-[var(--text-main)]/60 font-medium">ุงูุญุฑุงุฑุฉ</div>
            <div id="tempVal" class="text-xl font-semibold text-[var(--text-main)] mono mt-1">--.-ยฐC</div>
            <div id="tempHint" class="text-[11px] text-[var(--text-main)]/50 mt-1">โ</div>
          </div>

          <!-- COโ -->
          <div class="bg-white/70 rounded-lg border border-black/5 py-4">
            <div class="text-[11px] text-[var(--text-main)]/60 font-medium">ุฌูุฏุฉ ุงูููุงุก (COโ)</div>
            <div class="flex flex-col items-center mt-1">
              <div id="co2Val" class="text-xl font-semibold text-[var(--text-main)] mono">---- ppm</div>
              <div id="co2Hint" class="text-[11px] text-[var(--text-main)]/50 mt-1">โ</div>
            </div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-4 text-center">
          <!-- ุฅุฌูุงุฏ ุงูุฌูุณุฉ -->
          <div class="bg-white/70 rounded-lg border border-black/5 py-4 col-span-2 sm:col-span-1">
            <div class="text-[11px] text-[var(--text-main)]/60 font-medium">ุฅุฌูุงุฏ ุงูุฌูุณุฉ (fatigue)</div>
            <div id="fatigueVal" class="text-xl font-semibold text-[var(--text-main)] mono mt-1">0%</div>
            <div class="flex justify-center">
              <div id="fatigueBadge" class="badge-soft mt-2">ูุฑูุญ</div>
            </div>
          </div>

          <!-- ูุฌูุฏู -->
          <div class="bg-white/70 rounded-lg border border-black/5 py-4 col-span-2 sm:col-span-1">
            <div class="text-[11px] text-[var(--text-main)]/60 font-medium">ูุฌูุฏู</div>
            <div id="presenceVal" class="text-xl font-semibold text-[var(--text-main)] mono mt-1">โ</div>
            <div class="text-[11px] text-[var(--text-main)]/50 mt-1">1 = ููุฌูุฏ / 0 = ูู ููุฌูุฏ</div>
          </div>
        </div>

        <div class="text-[11px] text-[var(--text-main)]/50 mt-4 border-t border-black/10 pt-3 leading-relaxed">
          ูุนุชูุฏ GAIDESK ุนูู ุฌุณูู ููุณู ูู ุนูู ุชุงููุฑ ุซุงุจุช. ูู ุชุนุจู ููุตู 100% ูุงุฒู ุชููู ูุชุฃุฎุฐ ุจุฑูู.
        </div>
      </div>

      <!-- ุจุทุงูุฉ ุงูุชูุจูู ุงููุจุงุดุฑ -->
      <div class="glass-card p-5 flex flex-col justify-between lg:col-span-2">
        <div class="flex items-start justify-between">
          <div class="section-title">
            <span class="inline-block h-2 w-2 rounded-full bg-[var(--danger)] shadow-[0_0_8px_rgba(185,74,74,.6)]"></span>
            <span>ุงูุชูุจูู ุงูุญู</span>
          </div>

          <span id="lastUpdate"
            class="text-[11px] text-[var(--text-main)]/60 font-medium bg-white/60 px-2 py-[2px] rounded-md border border-black/5">
            ุขุฎุฑ ุชุญุฏูุซ: โ
          </span>
        </div>

        <div class="mt-4 bg-white/70 rounded-xl border border-black/5 p-5 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
          <div class="flex-1">
            <div id="alertTitle" class="text-[var(--text-main)] font-semibold text-lg leading-snug">
              ูู ุดูุก ุทุจูุนู ๐
            </div>
            <div id="alertDesc" class="text-[13px] text-[var(--text-main)]/70 mt-1 leading-relaxed">
              ุงูุฌูุณุฉ ุญุงููุงู ุฏุงุฎู ุงูุญุฏูุฏ ุงููุฑูุญุฉ. ููู ุดุบูู ๐
            </div>
          </div>

          <div class="flex flex-col items-stretch text-center min-w-[8rem]">
            <div id="alertBadge" class="badge-soft w-full text-center">
              ุทุจูุนู
            </div>
            <button
              onclick="location.href='/summary'"
              class="mt-3 text-[13px] font-medium bg-[var(--accent)] text-white rounded-lg px-4 py-2 shadow-sm hover:shadow transition">
              ุดูู ููุฎุต ุงูุฌูุณุฉ
            </button>
          </div>
        </div>

        <div class="text-[11px] text-[var(--text-main)]/50 mt-4 leading-relaxed">
          ูุธูุฑ ููุง ูู ูู ุดู ุฎุทุฑ ูุนูู (ูุถุนูุฉ ุฌููุณ ุณูุฆุฉ ุฌุฏูุง / ูุฑุจู ูู ุงูุดุงุดุฉ / COโ ุนุงูู / ุชุนุจ 100%). ุงูููุฑุฉ: ูุง ููุงุทุนู ุฅูุง ูู ุฌุณูู ูุนูุงู ุจุฏุฃ ูููุงุฑ ๐ฅ.
        </div>
      </div>

    </section>

    <!-- ===== ุฌุฏูู ุขุฎุฑ ุงููุฑุงุกุงุช ===== -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <div class="section-title text-[var(--text-main)]">
          <span class="inline-block h-2 w-2 rounded-full bg-[var(--text-main)]/50"></span>
          <span>ุขุฎุฑ ุงููุฑุงุกุงุช</span>
        </div>
        <div
          id="tableDeviceName"
          class="text-[11px] text-[var(--text-main)]/60 font-medium bg-white/60 px-2 py-[2px] rounded-md border border-black/5">
          ุงูุฌูุงุฒ: GAIDESK-01
        </div>
      </div>

      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-[13px] text-[var(--text-main)]">
            <thead class="bg-white/60 border-b border-black/10 text-[11px] text-[var(--text-main)]/60 font-medium">
              <tr class="text-center">
                <th class="py-3 px-2 whitespace-nowrap font-medium">ุงูููุช</th>
                <th class="py-3 px-2 whitespace-nowrap font-medium">ุงูู % ุฅุฌูุงุฏ</th>
                <th class="py-3 px-2 whitespace-nowrap font-medium">COโ</th>
                <th class="py-3 px-2 whitespace-nowrap font-medium">ยฐC</th>
                <th class="py-3 px-2 whitespace-nowrap font-medium">ูุฌูุฏ</th>
                <th class="py-3 px-2 whitespace-nowrap font-medium">ุงููุณุงูุฉ (ุณู)</th>
              </tr>
            </thead>
            <tbody id="readingsBody" class="divide-y divide-black/5 text-center">
              <!-- ุงูุณุทูุฑ ุชุชุนุจู ุจุงูุฌุงูุงุณูุฑุจุช -->
              <tr>
                <td colspan="6" class="py-8 text-[var(--text-main)]/40 text-[13px]">
                  ุฌุงุฑู ุงูุชุญููู...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p class="text-[11px] text-[var(--text-main)]/50 leading-relaxed">
        ูุนุฑุถ ุขุฎุฑ ุงูููุงุณุงุช ุงูุญููููุฉ ุงููู ุงูุฌูุงุฒ ุฑุณููุง: ุญุฑุงุฑุฉ / COโ / ูุฑุจู ูู ุงูุดุงุดุฉ / ูู ุฃูุช ููุฌูุฏ / ููุณุจุฉ ุงูุฅุฌูุงุฏ ูุญุธูุงู.
      </p>
    </section>

  </main>

  <!-- ุงูููุชุฑ -->
  <footer class="w-full border-t border-black/10 bg-[var(--panel)]/70 mt-12">
    <div class="max-w-6xl mx-auto px-4 py-6 text-[11px] flex flex-col sm:flex-row items-center justify-between gap-3 text-[var(--text-main)]/60 leading-relaxed">
      <div class="text-center sm:text-right">
        ยฉ <span id="year"></span> GAIDESK. ุฌููุน ุงูุญููู ูุญููุธุฉ.
      </div>
      <a href="https://www.linkedin.com/in/USERNAME_HERE"
         class="underline hover:text-[var(--accent)] transition"
         target="_blank" rel="noopener noreferrer">
        LinkedIn
      </a>
    </div>
  </footer>

  <!-- ุณูุฑุจุช ุฌูุจ ุงูุจูุงูุงุช ูุชุญุฏูุซ ุงูุตูุญุฉ -->
  <script>
    async function fetchData() {
      try {
        // ูุฌูุจ ุงูุฏุงุชุง ูู ุงูุณูุฑูุฑ ุชุจุนู (Flask API)
        // NOTE: ูุงุฒู ูู server.py ูููู ุนูุฏู /api/data ูุฑุฌุน ุขุฎุฑ ุงููุฑุงุกุงุช
        const r = await fetch('/api/data?limit=20');
        const json = await r.json(); // ุดูููุง [{key, value:{...}}]

        if (!Array.isArray(json) || json.length === 0) {
          setStatusEmpty();
          return;
        }

        // ุขุฎุฑ ุนูุตุฑ (ุฃุฌุฏุฏ ููุงุณ)
        const latest = json[0].value || {};
        const latestKey = json[0].key || "";
        updateNowSection(latest, latestKey);

        // ุงูุฌุฏูู
        renderTable(json);
      } catch (err) {
        console.error(err);
      }
    }

    function setStatusEmpty() {
        document.getElementById('tempVal').textContent = '--.-ยฐC';
        document.getElementById('tempHint').textContent = 'โ';

        document.getElementById('co2Val').textContent = '---- ppm';
        document.getElementById('co2Hint').textContent = 'โ';

        document.getElementById('fatigueVal').textContent = '0%';
        document.getElementById('fatigueBadge').textContent = 'โ';

        document.getElementById('presenceVal').textContent = 'โ';

        document.getElementById('alertTitle').textContent = 'ูุงูู ุจูุงูุงุช ุญุงููุงู';
        document.getElementById('alertDesc').textContent  = 'ุงูุฌูุงุฒ ูุง ุฃุฑุณู ูุฑุงุกุงุช ุฌุฏูุฏุฉ ููุญูู.';
        document.getElementById('alertBadge').textContent = 'ุจุงูุชุธุงุฑ ุงุชุตุงู';
        document.getElementById('alertBadge').className   = 'badge-warn w-full text-center';

        document.getElementById('lastUpdate').textContent = 'ุขุฎุฑ ุชุญุฏูุซ: โ';

        const tbody = document.getElementById('readingsBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="py-8 text-[var(--text-main)]/40 text-[13px]">
              ูุง ููุฌุฏ ูุฑุงุกุงุช ูุญููุธุฉ ุจุนุฏ.
            </td>
          </tr>`;
    }

    function qualityCO2(ppm) {
      if (ppm == null || isNaN(ppm)) return {txt:'โ',hint:'โ',bad:false};
      if (ppm > 2000) return {txt: ppm + ' ppm', hint:'ููุงุก ุณูุฆ ุฌุฏูุง', bad:true};
      if (ppm > 1500) return {txt: ppm + ' ppm', hint:'ููุงุก ูุชุนุจ', bad:true};
      return {txt: ppm + ' ppm', hint:'ููุงุก ููุจูู', bad:false};
    }

    function fatigueInfo(F) {
      if (F == null || isNaN(F)) return {pct:'0%', badge:'โ', warn:false};
      const pct = Math.round(F) + '%';
      if (F >= 100) return {pct, badge:'ูู ููุฑุงู', warn:true};
      if (F >= 70)  return {pct, badge:'ุฅุฌูุงุฏ ุนุงูู', warn:true};
      return {pct, badge:'ูุฑูุญ', warn:false};
    }

    function updateNowSection(latest, keyStr) {
      const temp = latest.t;
      const co2  = latest.co2;
      const pres = latest.presence;
      const dist = latest.dist;
      const F    = latest.F;

      // ุญุฑุงุฑุฉ
      document.getElementById('tempVal').textContent =
        (temp != null && !isNaN(temp)) ? temp.toFixed(1) + 'ยฐC' : '--.-ยฐC';

      document.getElementById('tempHint').textContent =
        (temp != null && !isNaN(temp))
          ? (temp > 30 ? 'ุฌู ุญุงุฑ' : 'ุฌู ุนุงุฏู')
          : 'โ';

      // CO2
      const co2q = qualityCO2(co2);
      document.getElementById('co2Val').textContent = co2q.txt;
      document.getElementById('co2Hint').textContent = co2q.hint;

      // ุฅุฌูุงุฏ
      const finfo = fatigueInfo(F);
      document.getElementById('fatigueVal').textContent = finfo.pct;
      const badgeEl = document.getElementById('fatigueBadge');
      badgeEl.textContent = finfo.badge;
      badgeEl.className = (finfo.warn ? 'badge-warn' : 'badge-soft') + ' mt-2';

      // ูุฌูุฏ
      document.getElementById('presenceVal').textContent =
        (pres === 1) ? 'ููุฌูุฏ' : (pres === 0) ? 'ูู ููุฌูุฏ' : 'โ';

      // ุขุฎุฑ ุชุญุฏูุซ
      const tsMs = latest.ts;
      let tsText = 'โ';
      if (typeof tsMs === 'number') {
        const d = new Date(tsMs);
        tsText = d.toLocaleString('ar-SA', { hour12:true });
      }
      document.getElementById('lastUpdate').textContent =
        'ุขุฎุฑ ุชุญุฏูุซ: ' + tsText;

      // ุงูุชูุจูู ุงูุญู
      const alertTitleEl = document.getElementById('alertTitle');
      const alertDescEl  = document.getElementById('alertDesc');
      const alertBadgeEl = document.getElementById('alertBadge');

      // ููุทู ุงูุชูุจูู
      if (finfo.warn) {
        alertTitleEl.textContent = 'ุฅุฌูุงุฏ ุนุงูู! ูุงุฒู ุชููู ุดููุฉ ';
        alertDescEl.textContent  = 'ุฌุณูู ูุงุนุฏ ูุชุนุจ. ุฎุฐ ุจุฑูู ุงูุขู ูุจู ูุง ุชูุตู ุญุฏ ุฎุทูุฑ.';
        alertBadgeEl.textContent = finfo.badge;
        alertBadgeEl.className   = 'badge-warn w-full text-center';
      } else if (co2q.bad) {
        alertTitleEl.textContent = 'ุงูููุงุก ูู ูููุณ ';
        alertDescEl.textContent  = 'ุงูุชุญ ุงูุดุจุงู / ุจุฏูู ุงูููุงู ูุญุธูุงู. ูุณุชูู COโ ูุฑุชูุน ููููู ูุณุจุจ ุตุฏุงุน ูุชุนุจ.';
        alertBadgeEl.textContent = 'ุชูููุฉ ุณูุฆุฉ';
        alertBadgeEl.className   = 'badge-warn w-full text-center';
      } else if (dist != null && !isNaN(dist) && dist < 45) {
        alertTitleEl.textContent = 'ูุฑูุจ ูุฑูู ูู ุงูุดุงุดุฉ ';
        alertDescEl.textContent  = 'ุงุจุนูุฏ ุดูู ุนู ุงูุดุงุดุฉ ุนุดุงู ุฑูุจุชู ูุนูููู.';
        alertBadgeEl.textContent = 'ูุถุนูุฉ ุบูุฑ ุตุญูุฉ';
        alertBadgeEl.className   = 'badge-warn w-full text-center';
      } else {
        alertTitleEl.textContent = 'ูู ุดูุก ุทุจูุนู ';
        alertDescEl.textContent  = 'ุงูุฌูุณุฉ ุญุงููุงู ุฏุงุฎู ุงูุญุฏูุฏ ุงููุฑูุญุฉ. ููู ุดุบูู';
        alertBadgeEl.textContent = 'ุทุจูุนู';
        alertBadgeEl.className   = 'badge-soft w-full text-center';
      }
    }

    function renderTable(list) {
      const tbody = document.getElementById('readingsBody');
      tbody.innerHTML = '';

      // list: [{key, value:{...}}, ...]  (ุฃุฌุฏุฏ ุฃูู ุนูุตุฑ)
      list.forEach((row, idx) => {
        const val = row.value || {};
        const ts  = val.ts;
        const d   = (typeof ts === 'number') ? new Date(ts) : null;
        const timeTxt = d
          ? d.toLocaleString('ar-SA', {hour12:true})
          : 'โ';

        const finfo = fatigueInfo(val.F);
        const co2v  = (val.co2 != null && !isNaN(val.co2)) ? val.co2 : 'โ';
        const tempv = (val.t   != null && !isNaN(val.t))   ? val.t.toFixed(1) : 'โ';
        const presv = (val.presence === 1) ? 'ููุฌูุฏ' :
                      (val.presence === 0) ? 'ูู ููุฌูุฏ' : 'โ';
        const distv = (val.dist != null && !isNaN(val.dist))
                      ? Math.round(val.dist) : 'โ';

        const tr = document.createElement('tr');
        tr.className = "text-center text-[13px] text-[var(--text-main)]/90 hover:bg-white/50 transition";

        tr.innerHTML = `
          <td class="py-3 px-2 whitespace-nowrap mono text-[var(--text-main)]/70">${timeTxt}</td>
          <td class="py-3 px-2 whitespace-nowrap mono">
            ${finfo.pct}
          </td>
          <td class="py-3 px-2 whitespace-nowrap mono">${co2v}</td>
          <td class="py-3 px-2 whitespace-nowrap mono">${tempv}</td>
          <td class="py-3 px-2 whitespace-nowrap">${presv}</td>
          <td class="py-3 px-2 whitespace-nowrap mono">${distv}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ุณูุฉ ูู ุงูููุชุฑ
    document.getElementById('year').textContent = new Date().getFullYear();

    // ุชุญุฏูุซ ูู ุดููุฉ (5 ุซูุงูู)
    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
